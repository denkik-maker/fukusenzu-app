<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>第二種電気工事士 複線図練習アプリ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { touch-action: manipulation; background-color: #f3f4f6; }
        .canvas-container { position: relative; width: 100%; height: 500px; background: white; border: 2px solid #ddd; overflow: hidden; }
        .label-bg { background: rgba(255, 255, 255, 0.8); padding: 0 2px; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // アイコンコンポーネントの簡易実装
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const App = () => {
            const [lines, setLines] = useState([]);
            const [selection, setSelection] = useState(null);
            const [color, setColor] = useState('black');
            const [thickness, setThickness] = useState(1.6);
            const [stamps, setStamps] = useState({});
            const [showGuide, setShowGuide] = useState(false);
            const [message, setMessage] = useState("端子をタップして結線を始めてください");

            // 器具配置データ (No.1想定)
            const components = [
                { id: 'power_l', label: '電源 L', x: 50, y: 100, type: 'power', isJB: false },
                { id: 'power_n', label: '電源 N (W)', x: 50, y: 150, type: 'power', isJB: false },
                { id: 'lamp', label: 'ランプレセプタクル (W)', x: 300, y: 50, type: 'load', isJB: false },
                { id: 'switch', label: 'スイッチ', x: 300, y: 250, type: 'switch', isJB: false },
                { id: 'jb', label: 'ジョイントボックス', x: 150, y: 80, width: 100, height: 140, type: 'jb', isJB: true }
            ];

            // 結線 (2タップ接続)
            const handlePointClick = (id) => {
                if (!selection) {
                    setSelection(id);
                    setMessage("次に接続先（ジョイントボックス内など）をタップしてください");
                } else {
                    if (selection === id) {
                        setSelection(null);
                        return;
                    }
                    // ジョイントボックス外同士の直接接続を制限
                    const from = components.find(c => c.id === selection);
                    const to = components.find(c => c.id === id);
                    if (!from.isJB && !to.isJB) {
                        setMessage("⚠️器具同士を直接結線できません。ボックスを経由してください");
                        setSelection(null);
                        return;
                    }

                    const newLine = {
                        id: Date.now(),
                        from: selection,
                        to: id,
                        color,
                        thickness
                    };
                    setLines([...lines, newLine]);
                    setSelection(null);
                    setMessage("接続しました");
                }
            };

            // 長押し削除
            const timerRef = useRef();
            const handleLongPress = (lineId) => {
                setLines(lines.filter(l => l.id !== lineId));
                setMessage("配線を削除しました");
            };

            // 全消去
            const allClear = () => {
                setLines([]);
                setStamps({});
                setSelection(null);
                setMessage("全消去しました");
            };

            // 刻印判定ロジック
            const checkResult = () => {
                // ここに太さ・色・刻印の判定ロジックを実装
                // 簡略化のため電源L-JB間が2.0mmかチェック
                const powerLine = lines.find(l => (l.from === 'power_l' || l.to === 'power_l'));
                if (!powerLine || powerLine.thickness !== 2.0) {
                    alert("不合格：電源ラインの太さが1.6mmになっています（正：2.0mm）");
                    return;
                }
                alert("合格！おめでとうございます！全ての条件を満たしています。");
            };

            return (
                <div className="max-w-md mx-auto p-4 flex flex-col h-screen">
                    <div className="flex justify-between items-center mb-4">
                        <h1 className="text-xl font-bold">複線図マスター</h1>
                        <button onClick={() => setShowGuide(true)} className="p-2 bg-gray-200 rounded-full">
                            <Icon name="help-circle" />
                        </button>
                    </div>

                    <div className="canvas-container rounded-lg mb-4 relative">
                        <svg className="w-full h-full">
                            {/* 配線の描画 */}
                            {lines.map(line => {
                                const from = components.find(c => c.id === line.from);
                                const to = components.find(c => c.id === line.to);
                                return (
                                    <line 
                                        key={line.id}
                                        x1={from.x} y1={from.y} x2={to.x} y2={to.y}
                                        stroke={line.color}
                                        strokeWidth={line.thickness === 2.0 ? 6 : 3}
                                        onContextMenu={(e) => { e.preventDefault(); handleLongPress(line.id); }}
                                    />
                                );
                            })}
                            
                            {/* ジョイントボックス */}
                            <rect x="150" y="80" width="100" height="140" fill="none" stroke="#666" strokeDasharray="5,5" />
                            
                            {/* 端子・ドットの描画 */}
                            {components.map(c => (
                                <g key={c.id} onClick={() => handlePointClick(c.id)}>
                                    <circle 
                                        cx={c.x} cy={c.y} r={c.isJB ? 8 : 6} 
                                        fill={selection === c.id ? "#3b82f6" : "#333"} 
                                    />
                                    <text x={c.x + 10} y={c.y + 5} className="text-xs font-bold label-bg">
                                        {c.label}
                                    </text>
                                </g>
                            ))}
                        </svg>
                    </div>

                    {/* 操作パネル */}
                    <div className="bg-white p-4 rounded-xl shadow-lg">
                        <p className="text-sm mb-3 text-blue-600 font-medium">{message}</p>
                        <div className="flex gap-4 mb-4 overflow-x-auto pb-2">
                            <div className="flex border rounded overflow-hidden">
                                {['black', 'white', 'red'].map(c => (
                                    <button 
                                        key={c} onClick={() => setColor(c)}
                                        className={`w-10 h-10 ${color === c ? 'ring-2 ring-blue-500' : ''}`}
                                        style={{ backgroundColor: c === 'white' ? '#eee' : c }}
                                    />
                                ))}
                            </div>
                            <div className="flex border rounded overflow-hidden">
                                {[1.6, 2.0].map(t => (
                                    <button 
                                        key={t} onClick={() => setThickness(t)}
                                        className={`px-3 py-2 ${thickness === t ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}
                                    >
                                        {t}mm
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={allClear} className="bg-red-100 text-red-600 py-3 rounded-lg font-bold">全消去</button>
                            <button onClick={checkResult} className="bg-blue-600 text-white py-3 rounded-lg font-bold">判定実行</button>
                        </div>
                    </div>

                    {/* ガイドモーダル */}
                    {showGuide && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-6 z-50">
                            <div className="bg-white p-6 rounded-2xl max-w-sm">
                                <h2 className="text-lg font-bold mb-4">操作方法</h2>
                                <ul className="text-sm space-y-2 mb-6">
                                    <li>・端子を2つ選ぶと線が引けます</li>
                                    <li>・配線は必ずボックスを経由してください</li>
                                    <li>・太さ2.0mmは線が太くなります</li>
                                    <li>・右クリック(PC)か長押しで配線削除</li>
                                </ul>
                                <button onClick={() => setShowGuide(false)} className="w-full bg-gray-800 text-white py-2 rounded-lg">閉じる</button>
                            </div>
                        </div>
                    )}
                </div>
            );

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
    </script>
</body>
</html>
